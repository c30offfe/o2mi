<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Step Grid</title>
  <style>
    html, body { width:100%; height:100%; margin:0; }
    body { background: rgba(0,0,0,0); font-family: system-ui, sans-serif; }
    .panel {
      position: absolute; top: 20px; left: 20px;
      background: rgba(0,0,0,0.65); color: #fff;
      padding: 12px; border-radius: 12px;
      width: 640px;
    }
    .hint { opacity: 0.85; font-size: 13px; margin-top: 4px; }
    .trackRow { display:flex; align-items:center; gap:10px; margin-top:10px; }
    .trackName { width: 70px; opacity: .9; font-size: 13px; }
    .grid { display:grid; grid-template-columns: repeat(16, 1fr); gap:6px; width: 100%; }
    .step {
      height: 22px; border-radius: 6px; cursor: pointer;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.18);
    }
    .step.on { background: rgba(0,255,120,0.55); border-color: rgba(0,255,120,0.9); }
    .step.play { outline: 2px solid rgba(255,255,255,0.9); }
    .small { opacity: 0.75; font-size: 12px; margin-top: 10px; }
  </style>
</head>
<body>
<div class="panel">
  <div id="status">Overlay geladen…</div>
  <div class="hint" id="hint">Klick: Step toggeln (mehrere Tracks)</div>

  <div id="tracks"></div>

  <div class="small" id="debug"></div>
</div>

<script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"></script>
<script>
  const STEPS = 16;

  // Tracks
  const trackNames = ["Kick", "Snare", "Hat", "Bass"];

  // state[trackIndex][stepIndex] => boolean
  const state = trackNames.map(() => new Array(STEPS).fill(false));

  const tracksEl = document.getElementById("tracks");
  const statusEl = document.getElementById("status");
  const hintEl   = document.getElementById("hint");
  const debugEl  = document.getElementById("debug");

  // Playhead
  let playStep = 0;
  const bpm = 90;
  const stepMs = (60_000 / bpm) / 4; // 16tel

  // --- Bits (Schritt 5A: Frontend-Flow) ---
  // 1) Lege in der Extension-Konsole ein Bits-Produkt mit genau dieser SKU an.
  // 2) Dann öffnet ein Klick den Bits-Dialog, und erst nach Kauf toggeln wir den Step.
  const BITS_SKU_STEP = "step_toggle_10";

  // Schalter für Debug: wenn Bits (noch) nicht konfiguriert sind, kannst du hier "true" lassen,
  // dann toggelt ein Klick ohne Bits.
  const ALLOW_FREE_TOGGLE_IF_BITS_NOT_READY = true;

  // Wir merken uns "welcher Klick wartet gerade auf Zahlung?"
  // {t, i}
  let pendingToggle = null;

  function patternStringForTrack(t) {
    return state[t].map(x => x ? "1" : "0").join("");
  }

  function updateDebug() {
    const lines = [];
    for (let t = 0; t < trackNames.length; t++) {
      lines.push(`${trackNames[t]}: ${patternStringForTrack(t)}`);
    }
    debugEl.textContent = lines.join("   |   ");
  }

  function render() {
    tracksEl.innerHTML = "";

    for (let t = 0; t < trackNames.length; t++) {
      const row = document.createElement("div");
      row.className = "trackRow";

      const name = document.createElement("div");
      name.className = "trackName";
      name.textContent = trackNames[t];

      const grid = document.createElement("div");
      grid.className = "grid";

      for (let i = 0; i < STEPS; i++) {
        const on = state[t][i];
        const isPlay = (i === playStep);

        const b = document.createElement("div");
        b.className = "step" + (on ? " on" : "") + (isPlay ? " play" : "");
        b.title = `${trackNames[t]} — Step ${i + 1}`;

        b.onclick = () => onStepClick(t, i);

        grid.appendChild(b);
      }

      row.appendChild(name);
      row.appendChild(grid);
      tracksEl.appendChild(row);
    }
  }

  function applyToggle(t, i) {
    state[t][i] = !state[t][i];
    render();
    updateDebug();
  }

  function onStepClick(t, i) {
    // Wenn Bits verfügbar sind -> Purchase Flow
    if (globalThis.Twitch?.ext?.bits?.useBits) {
      pendingToggle = { t, i };
      hintEl.textContent = `Bits-Kauf: ${trackNames[t]} Step ${i+1}…`;
      Twitch.ext.bits.useBits(BITS_SKU_STEP);
      return;
    }

    // Fallback (wenn Bits nicht bereit)
    if (ALLOW_FREE_TOGGLE_IF_BITS_NOT_READY) {
      applyToggle(t, i);
      // return;
    }
  }

  // Bits callback: wenn Kauf durch ist, toggle den Step
  // Achtung: Das ist der "ohne Backend"-Weg. Für echtes Production musst du serverseitig verifizieren (Schritt 5B).
  if (globalThis.Twitch?.ext?.bits?.onTransactionComplete) {
    Twitch.ext.bits.onTransactionComplete((tx) => {
      console.log("bits tx complete", tx);

      // sehr simple SKU-Prüfung (Client-seitig)
      const sku = tx?.product?.sku;
      if (sku !== BITS_SKU_STEP) return;

      if (pendingToggle) {
        applyToggle(pendingToggle.t, pendingToggle.i);
        hintEl.textContent = `Kauf OK ✅ ${trackNames[pendingToggle.t]} Step ${pendingToggle.i+1}`;
        pendingToggle = null;
      }
    });
  }

  // Start UI
  render();
  updateDebug();

  // Start playhead
  setInterval(() => {
    playStep = (playStep + 1) % STEPS;
    render();
  }, stepMs);

  Twitch.ext.onAuthorized((auth) => {
    statusEl.textContent = `Overlay läuft ✅ (authorized) — channelId=${auth.channelId}`;
  });
</script>
</body>
</html>
